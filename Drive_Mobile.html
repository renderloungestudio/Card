<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Monaco Taxi Fare & Walk Time</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #111;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    #container {
      width: 700px;
      background: #000;
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 0 20px rgba(0,0,0,0.6);
    }
    #header {
      display: flex;
      align-items: center;
      margin-bottom: 0px;
    }
    #header h2 {
      margin: 0;
      font-size: 15px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .row {
      display: flex;
      gap: 15px;
    }
    .left-col {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .right-col {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    label {
      margin: 5px 0 5px;
      font-size: 10px;
    }
    input {
      width: 70%;
      padding: 8px;
      border-radius: 10px;
      border: none;
      outline: none;
      font-size: 10px;
      box-sizing: border-box;
    }
    button {
      width: 70%;
      background: #FFD700;
      color: #000;
      border: none;
      padding: 8px;
      border-radius: 10px;
      font-weight: bold;
      font-size: 10px;
      margin-top: 23px;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover {
      background: #e6c200;
    }
    #map {
      height: 115px;
      width: 130%;
      left: -30%;
      top: -10%;
      border-radius: 12px;
      overflow: hidden;
    }
    #result {
      margin-top: -10px;
      display: flex;
      gap: 10px;
      justify-content: space-between;
      margin-left: -102px;
    }
    .fare-card {
      flex: 1;
      background: #222;
      padding: 12px;
      border-radius: 12px;
      font-size: 10px;
    }
    .fare-card h3 {
      margin: 0 0 6px;
      font-size: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCymv9ETNwMU60eBHP5kLP5ZxOwVaPc1QY&libraries=places"></script>
</head>
<body>
  <div id="container">
    <div id="header">
      <h2><img src="Driver.png" alt="Driver" style="height: 28px; vertical-align: middle; border-radius: 50%;"> Taxi Fare</h2>
    </div>

    <div class="row">
      <!-- LEFT SIDE: inputs + button -->
      <div class="left-col">
        <label>Pickup (Origin)</label>
        <input id="origin" placeholder="Enter pickup location in Monaco" />

        <label>Drop (Destination)</label>
        <input id="destination" placeholder="Enter drop location in Monaco" />

        <label>Or enter measured distance (km)</label>
        <input id="measuredKm" placeholder="e.g. 2.3" />

        <button id="calcBtn">Calculate Fare</button>
      </div>

      <!-- RIGHT SIDE: Map + results -->
      <div class="right-col">
        <div id="map"></div>
        <div id="result"></div>
      </div>
    </div>
  </div>

<script>
// --- Allowed towns ---
const allowedTowns = ["Monaco", "Cap-d'Ail", "Beausoleil", "Roquebrune-Cap-Martin"];

// --- Monaco rates ---
const rates = {
  taxi: { base: 5, perKm: 2 }
};

let map, directionsService, directionsRenderer, trafficLayer, geocoder;
let activeInput = null;

function initMap() {
  map = new google.maps.Map(document.getElementById('map'), {
    center: { lat: 43.7384, lng: 7.4246 },
    zoom: 14
  });
  directionsService = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer({ map: map });

  trafficLayer = new google.maps.TrafficLayer();
  trafficLayer.setMap(map);

  geocoder = new google.maps.Geocoder();

  // Autocomplete
  const originAutocomplete = new google.maps.places.Autocomplete(
    document.getElementById('origin')
  );
  const destAutocomplete = new google.maps.places.Autocomplete(
    document.getElementById('destination')
  );

  originAutocomplete.addListener("place_changed", () => {
    let place = originAutocomplete.getPlace();
    validatePlace(place, "origin");
  });
  destAutocomplete.addListener("place_changed", () => {
    let place = destAutocomplete.getPlace();
    validatePlace(place, "destination");
  });

  document.getElementById("origin").addEventListener("focus", () => activeInput = "origin");
  document.getElementById("destination").addEventListener("focus", () => activeInput = "destination");

  // Map click autofill
  map.addListener("click", (e) => {
    if (!activeInput) return;
    geocoder.geocode({ location: e.latLng }, (results, status) => {
      if (status === "OK" && results[0]) {
        const isAllowed = results[0].address_components.some(c => allowedTowns.includes(c.long_name));
        if (isAllowed) {
          document.getElementById(activeInput).value = results[0].formatted_address;
        } else {
          alert("❌ Only Monaco, Cap-d'Ail, Beausoleil, Roquebrune-Cap-Martin allowed.");
        }
      }
    });
  });
}

// Validate input
function validatePlace(place, fieldId) {
  if (!place || !place.address_components) {
    document.getElementById(fieldId).value = "";
    alert("❌ Invalid location.");
    return;
  }
  const isAllowed = place.address_components.some(c => allowedTowns.includes(c.long_name));
  if (!isAllowed) {
    document.getElementById(fieldId).value = "";
    alert("❌ Location must be in Monaco, Cap-d'Ail, Beausoleil or Roquebrune-Cap-Martin.");
  }
}

// Helper: geocode & check
function isInAllowedTown(place, callback) {
  geocoder.geocode({ address: place }, (results, status) => {
    if (status === "OK" && results[0]) {
      const isAllowed = results[0].address_components.some(c => allowedTowns.includes(c.long_name));
      callback(isAllowed);
    } else {
      callback(false);
    }
  });
}

function computeFare(distanceKm) {
  return rates.taxi.base + (distanceKm * rates.taxi.perKm);
}

document.getElementById('calcBtn').addEventListener('click', () => {
  const measuredVal = document.getElementById('measuredKm').value.trim();
  const origin = document.getElementById('origin').value.trim();
  const destination = document.getElementById('destination').value.trim();

  if (measuredVal) {
    const km = parseFloat(measuredVal);
    if (!isFinite(km) || km <= 0) {
      showResult('<div class="fare-card">Invalid measured distance.</div>');
      return;
    }
    showFares(km, null, null, null, km + " km");
    directionsRenderer.set('directions', null);
    return;
  }

  if (!origin || !destination) {
    showResult('<div class="fare-card">Enter pickup & drop OR measured distance.</div>');
    return;
  }

  // Validate both
  isInAllowedTown(origin, (originValid) => {
    if (!originValid) {
      showResult('<div class="fare-card">❌ Pickup must be inside allowed towns.</div>');
      return;
    }
    isInAllowedTown(destination, (destValid) => {
      if (!destValid) {
        showResult('<div class="fare-card">❌ Drop must be inside allowed towns.</div>');
        return;
      }

      // Driving route
      directionsService.route(
        { origin, destination, travelMode: 'DRIVING', drivingOptions: { departureTime: new Date() } },
        (resp, status) => {
          if (status === 'OK') {
            directionsRenderer.setDirections(resp);
            const leg = resp.routes[0].legs[0];
            const distanceKm = leg.distance.value / 1000;
            const distanceText = leg.distance.text;
            const normalTime = leg.duration.text;
            const trafficTime = leg.duration_in_traffic ? leg.duration_in_traffic.text : "Not available";

            // Walking
            directionsService.route(
              { origin, destination, travelMode: 'WALKING' },
              (walkResp, walkStatus) => {
                let walkTime = null;
                if (walkStatus === 'OK') {
                  walkTime = walkResp.routes[0].legs[0].duration.text;
                }
                showFares(distanceKm, normalTime, trafficTime, walkTime, distanceText);
              }
            );
          } else {
            showResult('<div class="fare-card">Directions failed: ' + status + '</div>');
          }
        }
      );
    });
  });
});

function showFares(distanceKm, normalTime, trafficTime, walkTime, distanceText) {
  const taxiFare = computeFare(distanceKm);

  let carCard = `<div class="fare-card">
      <h3><img src="Car1.png" style="height: 15px;"> Car</h3>
      <strong>Estimated Fare: €${taxiFare.toFixed(2)}</strong><br>
      Total Distance: ${distanceText}<br>
      ${trafficTime ? `Duration with traffic: ${trafficTime}<br>` : ""}
      ${normalTime ? `Normal Duration: ${normalTime}<br>` : ""}
      Rate: Base €${rates.taxi.base} + €${rates.taxi.perKm}/km
    </div>`;

  let walkCard = "";
  if (walkTime) {
    walkCard = `<div class="fare-card">
        <h3><img src="Walk1.png" style="height: 15px;"> Walk</h3>
        Total Distance: ${distanceText}<br>
        Duration: ${walkTime}
      </div>`;
  }

  document.getElementById('result').innerHTML = carCard + walkCard;
}

window.onload = initMap;
</script>
</body>
</html>

